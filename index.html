<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Who's the Spy - Game Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- KEEP ALL UI STYLES SAME AS ORIGINAL --- */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap');
        body { font-family: 'Poppins', sans-serif; overflow-x: hidden; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); position: relative; min-height: 100vh; }
        .gradient-bg::before { content: ''; position: absolute; top:0; left:0; right:0; bottom:0; background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.15"/><circle cx="20" cy="80" r="0.5" fill="white" opacity="0.15"/><circle cx="80" cy="30" r="0.5" fill="white" opacity="0.15"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>'); animation: float 20s ease-in-out infinite; opacity:0.3;}
        @keyframes float {0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
        .card-shadow { box-shadow:0 20px 40px rgba(0,0,0,.15), 0 0 0 1px rgba(255,255,255,.1); backdrop-filter: blur(10px); border:1px solid rgba(255,255,255,.2); }
        .glass-effect { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); border:1px solid rgba(255,255,255,0.3); }
        .neon-glow { box-shadow:0 0 20px rgba(102,126,234,.5), 0 0 40px rgba(102,126,234,.3); }
        .pulse-animation { animation: pulse 2s infinite, glow 2s ease-in-out infinite alternate; }
        @keyframes pulse {0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
        @keyframes glow {from{box-shadow:0 0 20px rgba(239,68,68,.5)}to{box-shadow:0 0 30px rgba(239,68,68,.8),0 0 40px rgba(239,68,68,.3)}}
        .fade-in { animation: fadeIn .8s ease-out; } @keyframes fadeIn {from{opacity:0;transform:translateY(30px) scale(.95)}to{opacity:1;transform:translateY(0) scale(1)}}
        .hover-lift { transition: all .3s cubic-bezier(.4,0,.2,1);} .hover-lift:hover{ transform:translateY(-8px) scale(1.02); box-shadow:0 25px 50px rgba(0,0,0,.2);}
        .gradient-text{ background: linear-gradient(135deg,#667eea 0%,#764ba2 50%,#f093fb 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
        .floating-shapes{ position:absolute; width:100%; height:100%; overflow:hidden; z-index:0 } .shape{ position:absolute; opacity:.1; animation:floatShapes 15s infinite linear } @keyframes floatShapes {0%{transform:translateY(100vh) rotate(0deg)}100%{transform:translateY(-100px) rotate(360deg)}}
        .button-gradient{ background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); position:relative; overflow:hidden } .button-gradient::before{ content:''; position:absolute; top:0; left:-100%; width:100%; height:100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,.3), transparent); transition:left .5s } .button-gradient:hover::before{ left:100% }
        .sparkle::after{ content:'✨'; position:absolute; top:10px; right:10px; animation:sparkleRotate 3s ease-in-out infinite } @keyframes sparkleRotate {0%,100%{transform:rotate(0) scale(1)}50%{transform:rotate(180deg) scale(1.2)}}
        .typing-effect { border-right:2px solid #667eea; animation: blink 1s infinite } @keyframes blink{0%,50%{border-color:transparent}51%,100%{border-color:#667eea}}
        .status-indicator::before{ content:''; position:absolute; top:-2px; right:-2px; width:12px; height:12px; background:#10b981; border-radius:50%; animation:statusPulse 2s infinite}
        @keyframes statusPulse{0%{transform:scale(1);opacity:1}50%{transform:scale(1.3);opacity:.7}100%{transform:scale(1);opacity:1}}
        .message-bubble{position:relative; transform:translateX(-20px); opacity:0; animation:bubbleSlide .5s ease-out forwards} @keyframes bubbleSlide{to{transform:translateX(0);opacity:1}}
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- Floating shapes kept -->
    <div class="floating-shapes">
        <div class="shape text-6xl" style="left:10%">🕵️</div>
        <div class="shape text-4xl" style="left:20%">🎮</div>
        <div class="shape text-5xl" style="left:35%">🎯</div>
        <div class="shape text-3xl" style="left:50%">🗳️</div>
        <div class="shape text-4xl" style="left:70%">💬</div>
        <div class="shape text-5xl" style="left:85%">⚪</div>
    </div>

    <!-- ===== UI (unchanged) ===== -->
    <div class="container mx-auto px-4 py-8 relative z-10">
        <!-- Header -->
        <div class="text-center mb-12">
            <div class="sparkle">
                <h1 class="text-5xl md:text-7xl font-black mb-6 text-white drop-shadow-2xl typing-effect">🕵️ Who's the Spy</h1>
            </div>
            <p class="text-xl md:text-2xl text-white opacity-95 font-medium drop-shadow-lg">Game tebak kata seru untuk dimainkan bersama!</p>
            <div class="mt-4 flex justify-center space-x-2">
                <span class="inline-block w-3 h-3 bg-white rounded-full opacity-60 animate-bounce"></span>
                <span class="inline-block w-3 h-3 bg-white rounded-full opacity-60 animate-bounce" style="animation-delay:0.1s"></span>
                <span class="inline-block w-3 h-3 bg-white rounded-full opacity-60 animate-bounce" style="animation-delay:0.2s"></span>
            </div>
        </div>

        <!-- Main Menu -->
        <div id="mainMenu" class="max-w-lg mx-auto fade-in">
            <div class="glass-effect rounded-3xl p-10 card-shadow neon-glow">
                <div class="space-y-6">
                    <button onclick="showCreateRoom()" class="w-full button-gradient hover-lift text-white font-bold py-5 px-8 rounded-2xl text-lg shadow-lg">
                        <span class="flex items-center justify-center space-x-3"><span class="text-2xl">🎮</span><span>Buat Room Baru</span></span>
                    </button>
                    <button onclick="showJoinRoom()" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover-lift text-white font-bold py-5 px-8 rounded-2xl text-lg shadow-lg">
                        <span class="flex items-center justify-center space-x-3"><span class="text-2xl">🚪</span><span>Gabung Room</span></span>
                    </button>
                    <button onclick="showRules()" class="w-full bg-gradient-to-r from-purple-500 to-pink-600 hover-lift text-white font-bold py-5 px-8 rounded-2xl text-lg shadow-lg">
                        <span class="flex items-center justify-center space-x-3"><span class="text-2xl">📋</span><span>Cara Bermain</span></span>
                    </button>
                </div>
                <div class="mt-8 text-center"><p class="text-gray-600 text-sm font-medium">✨ Siap untuk jadi detektif terbaik? ✨</p></div>
            </div>
        </div>

        <!-- Create Room -->
        <div id="createRoom" class="max-w-lg mx-auto hidden">
            <div class="glass-effect rounded-3xl p-8 card-shadow">
                <div class="text-center mb-6">
                    <div class="text-4xl mb-3">🎮</div>
                    <h2 class="text-2xl font-bold gradient-text mb-2">Buat Room Baru</h2>
                    <p class="text-gray-600">Siapkan arena pertempuran detektif!</p>
                </div>
                <div class="space-y-5">
                    <div class="relative">
                        <input type="text" id="hostName" placeholder="Nama kamu" class="w-full px-4 py-4 border-2 border-gray-200 rounded-xl text-lg font-medium bg-white/80">
                        <div class="absolute inset-y-0 right-0 flex items-center pr-4"><span class="text-gray-400">👤</span></div>
                    </div>
                    <div class="relative">
                        <select id="playerCount" class="w-full px-4 py-4 border-2 border-gray-200 rounded-xl text-lg font-medium bg-white/80" onchange="toggleCustomInput()">
                            <option value="4">4 Pemain 👥</option>
                            <option value="5">5 Pemain 👥👤</option>
                            <option value="6">6 Pemain 👥👥</option>
                            <option value="7">7 Pemain 👥👥👤</option>
                            <option value="8">8 Pemain 👥👥👥</option>
                            <option value="random">🎲 Random (4-8 Pemain)</option>
                            <option value="custom">⚙️ Custom (4-15 Pemain)</option>
                        </select>
                        <div class="absolute inset-y-0 right-0 flex items-center pr-4 pointer-events-none"><span class="text-gray-400">▼</span></div>
                    </div>
                    <div id="customPlayerInput" class="relative hidden">
                        <input type="number" id="customPlayerCount" placeholder="Masukkan jumlah pemain (4-15)" min="4" max="15" class="w-full px-4 py-4 border-2 border-gray-200 rounded-xl text-lg font-medium bg-white/80">
                        <div class="absolute inset-y-0 right-0 flex items-center pr-4"><span class="text-gray-400">👥</span></div>
                    </div>
                    <button onclick="createRoom()" class="w-full button-gradient hover-lift text-white font-bold py-4 px-6 rounded-xl text-lg shadow-lg"><span class="flex items-center justify-center space-x-2"><span>🚀</span><span>Buat Room</span></span></button>
                    <button onclick="showMainMenu()" class="w-full bg-gray-400 hover:bg-gray-500 hover-lift text-white font-semibold py-4 px-6 rounded-xl">← Kembali</button>
                </div>
            </div>
        </div>

        <!-- Join Room -->
        <div id="joinRoom" class="max-w-lg mx-auto hidden">
            <div class="glass-effect rounded-3xl p-8 card-shadow">
                <div class="text-center mb-6">
                    <div class="text-4xl mb-3">🚪</div>
                    <h2 class="text-2xl font-bold gradient-text mb-2">Gabung Room</h2>
                    <p class="text-gray-600">Masuk ke arena pertempuran!</p>
                </div>
                <div class="space-y-5">
                    <div class="relative">
                        <input type="text" id="playerName" placeholder="Nama kamu" class="w-full px-4 py-4 border-2 border-gray-200 rounded-xl text-lg font-medium bg-white/80">
                        <div class="absolute inset-y-0 right-0 flex items-center pr-4"><span class="text-gray-400">👤</span></div>
                    </div>
                    <div class="relative">
                        <input type="text" id="roomCode" placeholder="Kode room (6 karakter)" class="w-full px-4 py-4 border-2 border-gray-200 rounded-xl text-lg font-medium bg-white/80 uppercase tracking-widest text-center">
                        <div class="absolute inset-y-0 right-0 flex items-center pr-4"><span class="text-gray-400">🔑</span></div>
                    </div>
                    <button onclick="joinRoom()" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover-lift text-white font-bold py-4 px-6 rounded-xl text-lg shadow-lg"><span class="flex items-center justify-center space-x-2"><span>🎯</span><span>Gabung Room</span></span></button>
                    <button onclick="showMainMenu()" class="w-full bg-gray-400 hover:bg-gray-500 hover-lift text-white font-semibold py-4 px-6 rounded-xl">← Kembali</button>
                </div>
            </div>
        </div>

        <!-- Rules -->
        <div id="rules" class="max-w-2xl mx-auto hidden">
            <div class="bg-white rounded-2xl p-8 card-shadow">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Cara Bermain Who's the Spy</h2>
                <div class="space-y-4 text-gray-700">
                    <div class="bg-blue-50 p-4 rounded-lg"><h3 class="font-semibold text-blue-800 mb-2">🎯 Tujuan Game</h3><p>Temukan siapa yang menjadi SPY di antara para pemain!</p></div>
                    <div class="bg-green-50 p-4 rounded-lg"><h3 class="font-semibold text-green-800 mb-2">🎮 Cara Bermain</h3><ul class="list-disc list-inside space-y-1"><li>Setiap pemain mendapat kata rahasia</li><li>SPY mendapat kata yang berbeda dari yang lain</li><li>MR. WHITE tidak mendapat kata apapun (kosong)</li><li>Bergiliran mendeskripsikan kata tanpa menyebutkan kata aslinya</li><li>Voting untuk menentukan siapa SPY atau MR. WHITE</li></ul></div>
                    <div class="bg-purple-50 p-4 rounded-lg"><h3 class="font-semibold text-purple-800 mb-2">👥 Role dalam Game</h3><p><strong>🔵 Pemain Biasa:</strong> Dapat kata normal<br><strong>🔴 SPY:</strong> Dapat kata berbeda<br><strong>⚪ MR. WHITE:</strong> Tidak dapat kata apapun</p></div>
                    <div class="bg-yellow-50 p-4 rounded-lg"><h3 class="font-semibold text-yellow-800 mb-2">🏆 Cara Menang</h3><p><strong>Pemain Biasa:</strong> Berhasil menemukan SPY atau MR. WHITE<br><strong>SPY:</strong> Tidak tertangkap dan MR. WHITE tertangkap<br><strong>MR. WHITE:</strong> Berhasil menebak kata normal setelah tertangkap</p></div>
                </div>
                <button onclick="showMainMenu()" class="w-full mt-6 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg">Kembali ke Menu</button>
            </div>
        </div>

        <!-- Waiting Room -->
        <div id="waitingRoom" class="max-w-2xl mx-auto hidden">
            <div class="bg-white rounded-2xl p-8 card-shadow">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Room: <span id="displayRoomCode" class="text-blue-600"></span></h2>
                    <p class="text-gray-600">Menunggu pemain lain bergabung...</p>
                </div>
                
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <h3 class="font-semibold text-gray-800 mb-3">Pemain di Room (<span id="currentPlayerCount">0</span>/<span id="maxPlayerCount">5</span>)</h3>
                    <div id="playerList" class="space-y-2"></div>
                </div>

                <div class="flex space-x-4">
                    <button id="startGameBtn" onclick="startGame()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed">Mulai Game</button>
                    <button onclick="leaveRoom()" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg">Keluar Room</button>
                </div>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="gameScreen" class="max-w-lg mx-auto hidden">
            <div class="glass-effect rounded-3xl p-6 card-shadow">
                <!-- Word Display -->
                <div class="text-center mb-6">
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-2xl border-2 border-blue-200 neon-glow">
                        <p class="text-sm font-bold text-blue-800 mb-2">🎯 KATA KAMU:</p>
                        <p id="playerWord" class="text-3xl font-black text-blue-600 tracking-wider drop-shadow-lg">LOADING...</p>
                        <div class="mt-3 flex justify-center space-x-1">
                            <div class="w-2 h-2 bg-blue-400 rounded-full animate-pulse"></div>
                            <div class="w-2 h-2 bg-blue-400 rounded-full animate-pulse" style="animation-delay:0.2s"></div>
                            <div class="w-2 h-2 bg-blue-400 rounded-full animate-pulse" style="animation-delay:0.4s"></div>
                        </div>
                    </div>
                </div>

                <!-- Current Turn Info -->
                <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-2xl p-4 mb-6 border-2 border-green-200">
                    <div class="flex justify-between items-center">
                        <div class="status-indicator">
                            <p class="text-sm font-bold text-green-700 mb-1">🎯 GILIRAN:</p>
                            <p id="currentPlayerTurn" class="font-black text-green-800 text-lg">-</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-bold text-green-700 mb-1">⏰ WAKTU:</p>
                            <p id="turnTimer" class="font-black text-green-800 text-2xl">--s</p>
                        </div>
                    </div>
                    <div class="mt-3 bg-green-200 rounded-full h-2 overflow-hidden">
                        <div id="turnProgress" class="bg-gradient-to-r from-green-400 to-emerald-500 h-full rounded-full" style="width:0%"></div>
                    </div>
                </div>

                <!-- Players Status -->
                <div class="bg-gray-50 rounded-lg p-3 mb-4">
                    <h3 class="font-semibold text-gray-800 mb-2 text-sm">👥 Status Pemain</h3>
                    <div id="gamePlayerList" class="grid grid-cols-2 gap-2"></div>
                </div>

                <!-- Chat Area -->
                <div class="bg-gray-50 rounded-lg p-3 mb-4">
                    <h3 class="font-semibold text-gray-800 mb-2 text-sm">💬 Chat</h3>
                    <div id="chatMessages" class="h-48 overflow-y-auto space-y-2 mb-3 p-2 bg-white rounded-lg text-sm">
                        <div class="text-center text-gray-500 text-xs">Game dimulai! Bergiliran mendeskripsikan kata kalian...</div>
                    </div>
                    <div class="flex space-x-2">
                        <input type="text" id="chatInput" placeholder="Ketik pesan..." class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg" onkeypress="handleChatKeyPress(event)">
                        <button onclick="sendMessage()" id="sendBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm">📤</button>
                    </div>
                </div>

                <div class="text-center">
                    <button id="voteButton" onclick="showVoting()" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-300 pulse-animation hidden">🗳️ Mulai Voting SPY/MR. WHITE</button>
                    <div id="waitingForDescriptions" class="w-full bg-gray-400 text-white font-semibold py-3 px-6 rounded-lg text-center">⏳ Menunggu semua pemain selesai deskripsi...</div>
                </div>
            </div>
        </div>

        <!-- Voting, Mr White, Game Result screens (unchanged) -->
        <div id="votingScreen" class="max-w-2xl mx-auto hidden">
            <div class="glass-effect rounded-3xl p-10 card-shadow">
                <div class="text-center mb-8">
                    <div class="text-6xl mb-4">🗳️</div>
                    <h2 class="text-3xl font-black gradient-text mb-3">VOTING TIME!</h2>
                    <p class="text-xl text-gray-700 font-semibold">Siapa SPY atau MR. WHITE?</p>
                </div>
                <div id="votingOptions" class="space-y-3 mb-6"></div>
                <div class="text-center">
                    <button id="submitVoteBtn" onclick="submitVote()" class="bg-gradient-to-r from-red-500 to-pink-600 hover-lift text-white font-bold py-4 px-10 rounded-2xl disabled:bg-gray-400 disabled:cursor-not-allowed text-lg shadow-lg" disabled>🗳️ Submit Vote</button>
                </div>
            </div>
        </div>

        <div id="mrWhiteGuess" class="max-w-2xl mx-auto hidden">
            <div class="bg-white rounded-2xl p-8 card-shadow">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">⚪ MR. WHITE TERTANGKAP!</h2>
                <div class="text-center mb-6">
                    <p class="text-lg text-gray-700 mb-4"><strong id="mrWhiteName"></strong> adalah MR. WHITE!</p>
                    <p class="text-gray-600">MR. WHITE punya kesempatan terakhir untuk menebak kata normal dan menang!</p>
                </div>
                <div id="mrWhiteGuessInput" class="space-y-4">
                    <input type="text" id="whiteGuessInput" placeholder="Tebak kata normal..." class="w-full px-4 py-3 border border-gray-300 rounded-lg text-center text-xl font-semibold">
                    <button onclick="submitMrWhiteGuess()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg">Submit Tebakan</button>
                </div>
                <div id="mrWhiteWaiting" class="text-center hidden"><div class="animate-pulse"><p class="text-gray-600">Menunggu MR. WHITE menebak...</p></div></div>
            </div>
        </div>

        <div id="gameResult" class="max-w-2xl mx-auto hidden">
            <div class="bg-white rounded-2xl p-8 card-shadow text-center">
                <div id="resultContent"></div>
                <div class="mt-6 space-y-3">
                    <button onclick="playAgain()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg">Main Lagi</button>
                    <button onclick="showMainMenu()" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg">Kembali ke Menu</button>
                </div>
            </div>
        </div>
    </div>

    <!-- =========================
         REALTIME FIREBASE LOGIC
         ========================= -->
    <script type="module">
      // Firebase modular SDK (v9)
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-app.js";
      import {
        getDatabase, ref, push, set, onChildAdded, onChildRemoved, onValue, update, get, remove, child
      } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-database.js";

      // ---------- CONFIG: gunakan config projectmu (sudah disertakan) ----------
      const firebaseConfig = {
        apiKey: "AIzaSyCIISpCe24KexjiiNYpuM3v7DhMOtewT_8",
        authDomain: "whos-the-spy-game.firebaseapp.com",
        databaseURL: "https://whos-the-spy-game-default-rtdb.firebaseio.com",
        projectId: "whos-the-spy-game",
        storageBucket: "whos-the-spy-game.firebasestorage.app",
        messagingSenderId: "267041654513",
        appId: "1:267041654513:web:f961b8ff449b0b1df20b50",
        measurementId: "G-1EZ9KQVTKC"
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      // ---------- local state ----------
      const state = {
        roomCode: null,
        playerId: null,
        playerName: null,
        isHost: false,
        players: {}, // { playerId: {name, isHost, alive}}
        assignments: {}, // filled by host when game starts
        roomState: null, // copy of /rooms/{code}/state
        wordPairs: [ /* same set as original (short sample below) */
          { normal: 'NASI', spy: 'ROTI' },
          { normal: 'KUCING', spy: 'ANJING' },
          { normal: 'MOBIL', spy: 'MOTOR' },
          { normal: 'LAUT', spy: 'DANAU' },
          { normal: 'MATAHARI', spy: 'BULAN' },
          { normal: 'KOPI', spy: 'TEH' },
          { normal: 'BUKU', spy: 'MAJALAH' },
          { normal: 'SEPATU', spy: 'SANDAL' },
          { normal: 'HUJAN', spy: 'SALJU' },
          { normal: 'DOKTER', spy: 'PERAWAT' }
        ],
        hostTimerInterval: null
      };

      // ---------- helpers ----------
      function uid() {
        return 'p_' + Date.now().toString(36) + '_' + Math.floor(Math.random()*1000);
      }

      function genRoomCode() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let code = '';
        for (let i=0;i<6;i++) code += chars.charAt(Math.floor(Math.random()*chars.length));
        return code;
      }

      // ---------- UI helpers (unchanged look) ----------
      function showScreen(id) {
        const screens = ['mainMenu','createRoom','joinRoom','rules','waitingRoom','gameScreen','votingScreen','mrWhiteGuess','gameResult'];
        screens.forEach(s => { const el = document.getElementById(s); if(!el) return; el.classList.add('hidden'); el.classList.remove('fade-in','bounce-in'); });
        const el = document.getElementById(id);
        if (el) { el.classList.remove('hidden'); el.classList.add('fade-in'); }
      }

      window.showMainMenu = () => { showScreen('mainMenu'); cleanupLocal(); };
      window.showCreateRoom = () => showScreen('createRoom');
      window.showJoinRoom = () => showScreen('joinRoom');
      window.showRules = () => showScreen('rules');

      function toggleCustomInput() {
        const sel = document.getElementById('playerCount');
        const custom = document.getElementById('customPlayerInput');
        if (sel && custom) {
          if (sel.value === 'custom') custom.classList.remove('hidden'); else custom.classList.add('hidden');
        }
      }

      // ---------- Firebase actions ----------
      async function writeRoomInitial(roomCode, maxPlayers = 5) {
        const now = Date.now();
        await set(ref(db, `rooms/${roomCode}`), {
          createdAt: now,
          maxPlayers: maxPlayers,
          state: {
            gameStarted: false,
            currentTurn: 0,
            turnPhase: 'description',
            turnTimer: 60
          }
        });
      }

      async function addPlayerToRoom(roomCode, playerId, name, isHost=false) {
        await set(ref(db, `rooms/${roomCode}/players/${playerId}`), {
          name, isHost: !!isHost, alive: true, joinedAt: Date.now()
        });
      }

      // Create Room (host)
      window.createRoom = async function() {
        const hostName = (document.getElementById('hostName')?.value || '').trim();
        if (!hostName) { alert('Mohon masukkan nama kamu!'); return; }

        // player count
        const playerCountValue = document.getElementById('playerCount')?.value || '5';
        let maxPlayers = 5;
        if (playerCountValue === 'random') maxPlayers = Math.floor(Math.random()*5)+4;
        else if (playerCountValue === 'custom') maxPlayers = parseInt(document.getElementById('customPlayerCount')?.value) || 5;
        else maxPlayers = parseInt(playerCountValue);

        const roomCode = genRoomCode();
        const playerId = uid();

        // write room + add host
        await writeRoomInitial(roomCode, maxPlayers);
        await addPlayerToRoom(roomCode, playerId, hostName, true);

        // local init
        state.roomCode = roomCode;
        state.playerId = playerId;
        state.playerName = hostName;
        state.isHost = true;

        // UI
        document.getElementById('displayRoomCode').textContent = roomCode;
        document.getElementById('maxPlayerCount').textContent = maxPlayers;
        document.getElementById('startGameBtn').classList.remove('hidden');

        // start listening
        listenRoom(roomCode);
        showScreen('waitingRoom');
      };

      // Join Room (client)
      window.joinRoom = async function() {
        const name = (document.getElementById('playerName')?.value || '').trim();
        const roomCode = (document.getElementById('roomCode')?.value || '').trim().toUpperCase();

        if (!name) { alert('Mohon masukkan nama kamu!'); return; }
        if (!roomCode || roomCode.length !== 6) { alert('Mohon masukkan kode room 6 karakter!'); return; }

        // check room exists
        const roomSnap = await get(ref(db, `rooms/${roomCode}`));
        if (!roomSnap.exists()) { alert('Room tidak ditemukan!'); return; }

        // add player
        const playerId = uid();
        await addPlayerToRoom(roomCode, playerId, name, false);

        // local
        state.roomCode = roomCode;
        state.playerId = playerId;
        state.playerName = name;
        state.isHost = false;

        document.getElementById('displayRoomCode').textContent = roomCode;
        const maxPlayers = roomSnap.val().maxPlayers || 5;
        document.getElementById('maxPlayerCount').textContent = maxPlayers;

        // listen
        listenRoom(roomCode);
        showScreen('waitingRoom');
      };

      // Leave Room
      window.leaveRoom = async function() {
        if (!state.roomCode || !state.playerId) { showMainMenu(); return; }
        try {
          await remove(ref(db, `rooms/${state.roomCode}/players/${state.playerId}`));
        } catch(e) { console.warn(e); }
        cleanupLocal();
        showMainMenu();
      };

      function cleanupLocal() {
        // stop host timer if any
        if (state.hostTimerInterval) { clearInterval(state.hostTimerInterval); state.hostTimerInterval = null; }
        // reset local object (but keep DOM intact)
        state.roomCode = null; state.playerId = null; state.playerName = null; state.isHost = false;
        state.players = {}; state.assignments = {}; state.roomState = null;
        // reset UI fields
        document.getElementById('playerList') && (document.getElementById('playerList').innerHTML = '');
        document.getElementById('currentPlayerCount') && (document.getElementById('currentPlayerCount').textContent = '0');
      }

      // Listen to room changes (players, chat, state, assignments)
      function listenRoom(roomCode) {
        // players
        onChildAdded(ref(db, `rooms/${roomCode}/players`), snap => {
          state.players[snap.key] = snap.val();
          renderPlayerList();
        });
        onChildRemoved(ref(db, `rooms/${roomCode}/players`), snap => {
          delete state.players[snap.key];
          renderPlayerList();
        });

        // chat
        onChildAdded(ref(db, `rooms/${roomCode}/chat`), snap => {
          const m = snap.val();
          appendChatMessage(m.player, m.message, m.type || 'chat');
        });

        // assignments (so each client can read its assignment)
        onValue(ref(db, `rooms/${roomCode}/assignments`), snap => {
          state.assignments = snap.val() || {};
          // set local player word if assigned
          if (state.playerId && state.assignments[state.playerId]) {
            const myAssign = state.assignments[state.playerId];
            const word = myAssign.word || '???';
            document.getElementById('playerWord') && (document.getElementById('playerWord').textContent = word);
          }
          renderGamePlayers();
        });

        // room state
        onValue(ref(db, `rooms/${roomCode}/state`), snap => {
          const s = snap.val();
          state.roomState = s || {};
          // update UI from state
          if (!s) return;
          // if gameStarted toggled
          if (s.gameStarted) {
            // show game screen
            showScreen('gameScreen');
            // show turn info
            updateTurnUI(s);
            // if we are host, ensure host timer is running on host role
            if (state.isHost && !state.hostTimerInterval) startHostTimerLoop();
          } else {
            // return to waiting room
            showScreen('waitingRoom');
            // stop host timer if exists
            if (state.hostTimerInterval) { clearInterval(state.hostTimerInterval); state.hostTimerInterval = null; }
          }
        });
      }

      // Render list of players in waiting room
      function renderPlayerList() {
        const list = document.getElementById('playerList');
        if (!list) return;
        list.innerHTML = '';
        const entries = Object.entries(state.players || {});
        entries.forEach(([pid, p]) => {
          const div = document.createElement('div');
          div.className = 'flex items-center justify-between bg-white p-3 rounded-lg';
          div.innerHTML = `<span class="font-medium">${p.name}</span>
            <span class="text-sm ${p.isHost ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-600'} px-2 py-1 rounded">
              ${p.isHost ? '👑 Host' : '👤 Player'}
            </span>`;
          list.appendChild(div);
        });
        document.getElementById('currentPlayerCount').textContent = entries.length;
      }

      // Append chat
      function appendChatMessage(player, message, type='chat') {
        const chat = document.getElementById('chatMessages');
        if (!chat) return;
        const div = document.createElement('div');
        div.className = `message-bubble p-4 rounded-2xl ${type==='description' ? 'bg-gradient-to-r from-blue-50 to-indigo-50 border-l-4 border-blue-500' : 'bg-gradient-to-r from-gray-50 to-slate-50'}`;
        div.innerHTML = `<div class="flex items-start space-x-3"><div class="flex-shrink-0"><span class="text-lg">${type==='description'?'🎯':'💬'}</span></div><div class="flex-1"><span class="font-bold text-sm ${type==='description'?'text-blue-700':''}">${player}${type==='description'?' (Deskripsi)':''}:</span><p class="text-gray-800 mt-1 font-medium">${message}</p></div></div>`;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
      }

      // send chat message
      window.sendMessage = async function() {
        const input = document.getElementById('chatInput');
        if (!state.roomCode || !state.playerId) { alert('Kamu belum di room!'); return; }
        const text = (input.value || '').trim();
        if (!text) return;
        // determine type: description if currently player's turn and in description phase
        let type = 'chat';
        const s = state.roomState || {};
        if (s.turnPhase === 'description' && s.currentTurn != null) {
          // get currentTurn playerId via mapping: we need order of players — host stored order? We'll infer by sorting join time.
          // To simplify: the host stored an ordered array in state.playerOrder when starting the game. We rely on that.
          const playerOrder = s.playerOrder || [];
          const currentPid = playerOrder[s.currentTurn];
          if (currentPid === state.playerId) type = 'description';
        }
        await set(push(ref(db, `rooms/${state.roomCode}/chat`)), { player: state.playerName, message: text, type, ts: Date.now() });
        input.value = '';
      };

      window.handleChatKeyPress = function(e) { if (e.key === 'Enter') sendMessage(); };

      // ---------- Host: start game (assign roles + words) ----------
      window.startGame = async function() {
        if (!state.isHost) { alert('Hanya host yang bisa memulai game'); return; }

        // collect current players in deterministic order (sort by joinedAt)
        const playersSnap = await get(ref(db, `rooms/${state.roomCode}/players`));
        const playersObj = playersSnap.exists() ? playersSnap.val() : {};
        const playerEntries = Object.entries(playersObj).map(([pid,p]) => ({ pid, ...p }));
        // sort by joinedAt to preserve order
        playerEntries.sort((a,b) => (a.joinedAt||0) - (b.joinedAt||0));
        const playerOrder = playerEntries.map(p => p.pid);

        // ensure enough players
        const maxPlayersStored = (await get(ref(db, `rooms/${state.roomCode}/maxPlayers`))).val();
        const minPlayers = 4;
        if (playerOrder.length < minPlayers) {
          if (!confirm(`Hanya ${playerOrder.length} pemain terdeteksi. Tetap mulai? (disarankan minimal ${minPlayers})`)) return;
        }

        // choose word pair
        const wp = state.wordPairs[Math.floor(Math.random()*state.wordPairs.length)];
        const normalWord = wp.normal;
        const spyWord = wp.spy;

        // pick spy and mrWhite
        const shuffled = playerOrder.slice();
        for (let i=shuffled.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [shuffled[i],shuffled[j]]=[shuffled[j],shuffled[i]]; }
        const spyPid = shuffled[0];
        const mrWhitePid = shuffled[1 % shuffled.length];

        // build assignments object
        const assignments = {};
        playerOrder.forEach(pid => {
          if (pid === spyPid) assignments[pid] = { role: 'SPY', word: spyWord };
          else if (pid === mrWhitePid) assignments[pid] = { role: 'MR_WHITE', word: null };
          else assignments[pid] = { role: 'CIVIL', word: normalWord };
        });

        // write assignments + update state atomically
        await update(ref(db), {
          [`rooms/${state.roomCode}/assignments`]: assignments,
          [`rooms/${state.roomCode}/state`]: {
            gameStarted: true,
            normalWord,
            spyWord,
            currentTurn: 0,
            turnPhase: 'description',
            turnTimer: 60,
            playerOrder: playerOrder
          }
        });

        // start host timer loop to tick turnTimer and progress turns
        startHostTimerLoop();
      };

      // host loop updates timer and currentTurn in DB
      function startHostTimerLoop() {
        if (!state.isHost || !state.roomCode) return;
        if (state.hostTimerInterval) clearInterval(state.hostTimerInterval);
        // interval every 1s update turnTimer in DB; host is authoritative
        state.hostTimerInterval = setInterval(async () => {
          const roomRef = ref(db, `rooms/${state.roomCode}/state`);
          const snap = await get(roomRef);
          if (!snap.exists()) { clearInterval(state.hostTimerInterval); state.hostTimerInterval = null; return; }
          const rs = snap.val();
          if (!rs.gameStarted) { clearInterval(state.hostTimerInterval); state.hostTimerInterval = null; return; }

          let tt = (rs.turnTimer != null) ? rs.turnTimer : 60;
          let ct = (rs.currentTurn != null) ? rs.currentTurn : 0;
          let phase = rs.turnPhase || 'description';
          // decrement
          tt = tt - 1;
          if (tt <= 0) {
            // advance
            if (phase === 'description') {
              // increment currentTurn
              const playerOrder = rs.playerOrder || [];
              ct = ct + 1;
              if (ct >= playerOrder.length) {
                // all described -> switch to discussion (no timer)
                phase = 'discussion';
                tt = 0;
              } else {
                tt = 60;
              }
            } else {
              // discussion phase; stop timer
              tt = 0;
            }
          }
          // write back
          await update(ref(db, `rooms/${state.roomCode}/state`), { turnTimer: tt, currentTurn: ct, turnPhase: phase });
        }, 1000);
      }

      // When a client sees a new state, update UI accordingly
      function updateTurnUI(s) {
        if (!s) return;
        // playerOrder determines current player pid
        const playerOrder = s.playerOrder || [];
        const currentPid = playerOrder[s.currentTurn] || null;
        const currentName = currentPid ? (state.players[currentPid]?.name || 'Player') : '-';
        document.getElementById('currentPlayerTurn').textContent = (s.turnPhase === 'description') ? currentName : 'Diskusi Bebas';
        document.getElementById('turnTimer').textContent = (s.turnPhase === 'description') ? `${s.turnTimer}s` : '∞';
        // progress bar (if description phase)
        if (s.turnPhase === 'description' && typeof s.turnTimer === 'number') {
          const pct = Math.max(0, Math.min(100, Math.round((s.turnTimer/60)*100)));
          document.getElementById('turnProgress').style.width = `${pct}%`;
        } else {
          document.getElementById('turnProgress').style.width = `100%`;
        }
        // show/hide voting button and waiting message
        if (s.turnPhase === 'discussion') {
          document.getElementById('voteButton').classList.remove('hidden');
          document.getElementById('waitingForDescriptions').classList.add('hidden');
        } else {
          document.getElementById('voteButton').classList.add('hidden');
          document.getElementById('waitingForDescriptions').classList.remove('hidden');
        }
      }

      // Render players in game status (grid)
      function renderGamePlayers() {
        const container = document.getElementById('gamePlayerList');
        if (!container) return;
        container.innerHTML = '';
        const order = (state.roomState && state.roomState.playerOrder) || Object.keys(state.players || {});
        order.forEach((pid, idx) => {
          const p = state.players[pid];
          if (!p) return;
          const div = document.createElement('div');
          const isCurrent = state.roomState && state.roomState.currentTurn === idx && state.roomState.turnPhase === 'description';
          const hasDescribed = (state.chatMessages || []).some(m => m.type === 'description' && m.player === p.name);
          div.className = `bg-white p-2 rounded text-center text-xs ${isCurrent ? 'ring-2 ring-green-500' : ''}`;
          div.innerHTML = `<div class="font-medium truncate">${p.name}</div><div class="text-xs mt-1">${isCurrent ? '🎯' : ''}</div>`;
          container.appendChild(div);
        });
      }

      // render player list in waiting room (same as renderPlayerList but kept separate if needed)
      function renderPlayerList() { // kept for compatibility
        const list = document.getElementById('playerList');
        if (!list) return;
        list.innerHTML = '';
        const players = Object.entries(state.players || {}).map(([pid,p]) => ({ pid, ...p }));
        // sort by joinedAt if possible
        players.sort((a,b) => (a.joinedAt||0) - (b.joinedAt||0));
        players.forEach(p => {
          const div = document.createElement('div');
          div.className = 'flex items-center justify-between bg-white p-3 rounded-lg';
          div.innerHTML = `<span class="font-medium">${p.name}</span>
            <span class="text-sm ${p.isHost ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-600'} px-2 py-1 rounded">
              ${p.isHost ? '👑 Host' : '👤 Player'}
            </span>`;
          list.appendChild(div);
        });
        document.getElementById('currentPlayerCount') && (document.getElementById('currentPlayerCount').textContent = players.length);
      }

      // ---------- Voting flow (client side uses state.assignments to determine result) ----------
      function showVoting() {
        // build options from current players
        const votingOptions = document.getElementById('votingOptions');
        votingOptions.innerHTML = '';
        const playersOrdered = (state.roomState && state.roomState.playerOrder) || Object.keys(state.players || {});
        playersOrdered.forEach(pid => {
          const p = state.players[pid];
          if (!p) return;
          const opt = document.createElement('div');
          opt.className = 'vote-option';
          opt.innerHTML = `<label class="flex items-center p-5 bg-gradient-to-r from-gray-50 to-slate-50 rounded-2xl cursor-pointer border-2 border-gray-200 hover:border-blue-300">
            <input type="radio" name="spyVote" value="${pid}" class="mr-4 w-5 h-5 text-blue-600">
            <div class="flex items-center space-x-3"><span class="text-2xl">👤</span><span class="font-bold text-lg text-gray-800">${p.name}</span></div>
          </label>`;
          votingOptions.appendChild(opt);
        });
        // enable submit button when selection changes
        votingOptions.querySelectorAll('input[name="spyVote"]').forEach(r => r.addEventListener('change', () => {
          document.getElementById('submitVoteBtn').disabled = false;
        }));
        showScreen('votingScreen');
      }
      window.showVoting = showVoting;

      async function submitVote() {
        const selected = document.querySelector('input[name="spyVote"]:checked');
        if (!selected) { alert('Pilih pemain yang ingin kamu vote'); return; }
        const votedPid = selected.value;
        // Write vote to DB under /rooms/{roomCode}/votes/{voterPid} = votedPid (optional)
        await set(ref(db, `rooms/${state.roomCode}/votes/${state.playerId}`), { voted: votedPid, ts: Date.now() });
        // Tally votes (simple approach: host tallies automatically by reading votes; here we do simple immediate check for demo)
        // For demo: let host evaluate after all votes present OR host can evaluate manually — we will make host evaluate when they press submitVote (host only)
        if (state.isHost) {
          // host tallies
          const votesSnap = await get(ref(db, `rooms/${state.roomCode}/votes`));
          const votesObj = votesSnap.exists() ? votesSnap.val() : {};
          // count votes per pid
          const counts = {};
          Object.values(votesObj).forEach(v => { const t = v.voted; counts[t] = (counts[t]||0)+1; });
          // find max
          let maxPid = null, maxCount = -1;
          Object.entries(counts).forEach(([pid,c]) => { if (c > maxCount) { maxCount = c; maxPid = pid; } });
          // decide result
          const spyPid = Object.entries(state.assignments || {}).find(([k,v]) => v.role === 'SPY')?.[0];
          const mrWhitePid = Object.entries(state.assignments || {}).find(([k,v]) => v.role === 'MR_WHITE')?.[0];
          if (maxPid === mrWhitePid) {
            // mr white caught -> show mr white guess screen
            // set special node so clients react
            await update(ref(db, `rooms/${state.roomCode}/state`), { lastVotedPid: maxPid, votingResult: 'mr_white' });
            // show mr white guess to everyone (clients display accordingly)
            showScreen('mrWhiteGuess');
            document.getElementById('mrWhiteName').textContent = state.players[mrWhitePid]?.name || 'MR. WHITE';
            // if current client is mrWhite, show input, others show waiting
            if (state.playerId === mrWhitePid) {
              document.getElementById('mrWhiteGuessInput').classList.remove('hidden');
              document.getElementById('mrWhiteWaiting').classList.add('hidden');
            } else {
              document.getElementById('mrWhiteGuessInput').classList.add('hidden');
              document.getElementById('mrWhiteWaiting').classList.remove('hidden');
            }
          } else if (maxPid === spyPid) {
            // spy caught -> civilians win
            showGameResult('spy_caught');
          } else {
            // wrong vote -> spy & mr white win
            showGameResult('wrong_vote', maxPid);
          }
        } else {
          alert('Vote terkirim. Tunggu host untuk menyelesaikan voting.');
        }
      }
      window.submitVote = submitVote;

      // Mr White guess submit
      window.submitMrWhiteGuess = async function() {
        const guess = (document.getElementById('whiteGuessInput')?.value || '').trim().toUpperCase();
        if (!guess) return alert('Masukkan tebakan!');
        const normal = (state.roomState && state.roomState.normalWord) || '';
        if (guess === normal.toUpperCase()) {
          // mr white wins
          showGameResult('mr_white_wins');
        } else {
          showGameResult('civilians_win', guess);
        }
      };

      // Show result screen
      function showGameResult(type, extra) {
        showScreen('gameResult');
        const rc = document.getElementById('resultContent');
        const spyPid = Object.entries(state.assignments || {}).find(([k,v]) => v.role === 'SPY')?.[0];
        const mrWhitePid = Object.entries(state.assignments || {}).find(([k,v]) => v.role === 'MR_WHITE')?.[0];
        const spyName = spyPid ? (state.players[spyPid]?.name || 'SPY') : 'SPY';
        const mrWhiteName = mrWhitePid ? (state.players[mrWhitePid]?.name || 'MR. WHITE') : 'MR. WHITE';
        const normalWord = state.roomState?.normalWord || '';
        const spyWord = state.roomState?.spyWord || '';
        let html = '';
        if (type === 'spy_caught') {
          html = `<div class="text-center"><div class="text-6xl mb-4">🎉</div><h2 class="text-3xl font-bold text-green-600 mb-4">SPY TERTANGKAP!</h2><p class="text-lg text-gray-700 mb-4"><strong>${spyName}</strong> adalah SPY!</p><div class="bg-green-50 p-4 rounded-lg"><p class="text-green-800"><strong>🔵 Kata Normal:</strong> ${normalWord}<br><strong>🔴 Kata SPY:</strong> ${spyWord}<br><strong>⚪ MR. WHITE:</strong> ${mrWhiteName}</p></div></div>`;
        } else if (type === 'mr_white_wins') {
          html = `<div class="text-center"><div class="text-6xl mb-4">⚪</div><h2 class="text-3xl font-bold text-purple-600 mb-4">MR. WHITE MENANG!</h2><p class="text-lg text-gray-700 mb-4"><strong>${mrWhiteName}</strong> berhasil menebak kata normal!</p><div class="bg-purple-50 p-4 rounded-lg"><p class="text-purple-800"><strong>🔵 Kata Normal:</strong> ${normalWord}<br><strong>🔴 SPY:</strong> ${spyName}<br><strong>⚪ MR. WHITE:</strong> ${mrWhiteName}</p></div></div>`;
        } else if (type === 'civilians_win') {
          html = `<div class="text-center"><div class="text-6xl mb-4">🎉</div><h2 class="text-3xl font-bold text-blue-600 mb-4">PEMAIN BIASA MENANG!</h2><p class="text-lg text-gray-700 mb-4">MR. WHITE tertangkap dan gagal menebak! Tebakan: <strong>${extra||''}</strong></p><div class="bg-blue-50 p-4 rounded-lg"><p class="text-blue-800"><strong>🔵 Kata Normal:</strong> ${normalWord}<br><strong>🔴 SPY:</strong> ${spyName}<br><strong>⚪ MR. WHITE:</strong> ${mrWhiteName}</p></div></div>`;
        } else if (type === 'wrong_vote') {
          html = `<div class="text-center"><div class="text-6xl mb-4">🕵️</div><h2 class="text-3xl font-bold text-red-600 mb-4">SPY & MR. WHITE MENANG!</h2><p class="text-lg text-gray-700 mb-4">Salah tebak! Yang dipilih: <strong>${extra||''}</strong><br>SPY: <strong>${spyName}</strong><br>MR. WHITE: <strong>${mrWhiteName}</strong></p></div>`;
        }
        rc.innerHTML = html;
      }

      // playAgain (host only)
      window.playAgain = async function() {
        if (!state.isHost) { alert('Hanya host yang bisa memulai ulang game'); return; }
        // reset state & assignments & votes & chat
        await update(ref(db, `rooms/${state.roomCode}`), {
          state: { gameStarted: false, currentTurn: 0, turnPhase: 'description', turnTimer: 60 },
          assignments: null,
          votes: null,
          chat: null
        });
        // show waiting room
        showScreen('waitingRoom');
      };

      // Before unload remove player
      window.addEventListener('beforeunload', async () => {
        try { if (state.roomCode && state.playerId) await remove(ref(db, `rooms/${state.roomCode}/players/${state.playerId}`)); } catch(e) {}
      });

      // initial show
      showScreen('mainMenu');
    </script>

    <!-- END -->
</body>
</html>
