<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Who's the Spy - Game Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap');
        body { 
            font-family: 'Poppins', sans-serif; 
            overflow-x: hidden;
        }
        
        .gradient-bg { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            position: relative;
            min-height: 100vh;
        }
        
        .gradient-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="0.5" height="0.5" patternUnits="userSpaceOnUse"><circle cx="0.25" cy="0.25" r="0.25" fill="rgba(255,255,255,0.05)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
        }
    </style>
</head>
<body class="gradient-bg flex items-center justify-center p-6">

    <!-- MAIN MENU -->
    <div id="mainMenu" class="w-full max-w-md bg-white rounded-2xl shadow-lg p-6 space-y-4 relative z-10">
        <h1 class="text-2xl font-bold text-center">Who's the Spy ðŸŽ­</h1>
        <button onclick="document.getElementById('createRoom').classList.remove('hidden'); document.getElementById('mainMenu').classList.add('hidden');"
            class="w-full bg-indigo-500 text-white py-2 rounded-lg">Buat Room</button>
        <button onclick="document.getElementById('joinRoom').classList.remove('hidden'); document.getElementById('mainMenu').classList.add('hidden');"
            class="w-full bg-purple-500 text-white py-2 rounded-lg">Gabung Room</button>
    </div>

    <!-- CREATE ROOM -->
    <div id="createRoom" class="hidden w-full max-w-md bg-white rounded-2xl shadow-lg p-6 space-y-4 relative z-10">
        <h2 class="text-xl font-bold">Buat Room</h2>
        <input id="hostName" placeholder="Nama kamu" class="w-full border p-2 rounded" />
        <button onclick="createRoom()" class="w-full bg-indigo-500 text-white py-2 rounded-lg">Buat</button>
    </div>

    <!-- JOIN ROOM -->
    <div id="joinRoom" class="hidden w-full max-w-md bg-white rounded-2xl shadow-lg p-6 space-y-4 relative z-10">
        <h2 class="text-xl font-bold">Gabung Room</h2>
        <input id="playerName" placeholder="Nama kamu" class="w-full border p-2 rounded" />
        <input id="roomCode" placeholder="Kode room" class="w-full border p-2 rounded uppercase" />
        <button onclick="joinRoom()" class="w-full bg-purple-500 text-white py-2 rounded-lg">Gabung</button>
    </div>

    <!-- WAITING ROOM -->
    <div id="waitingRoom" class="hidden w-full max-w-md bg-white rounded-2xl shadow-lg p-6 space-y-4 relative z-10">
        <h2 class="text-xl font-bold">Room Code: <span id="displayRoomCode"></span></h2>
        <p>Pemain: <span id="currentPlayerCount">0</span></p>
        <div id="playerList" class="space-y-2"></div>
        <button id="startGameBtn" onclick="startGame()" class="hidden w-full bg-green-500 text-white py-2 rounded-lg">Mulai Game</button>
    </div>

    <!-- GAME SCREEN -->
    <div id="gameScreen" class="hidden w-full max-w-md bg-white rounded-2xl shadow-lg p-6 space-y-4 relative z-10">
        <h2 class="text-xl font-bold">Game Dimulai ðŸŽ®</h2>
        <div id="chatMessages" class="h-64 overflow-y-auto border p-2 rounded space-y-2"></div>
        <div class="flex space-x-2">
            <input id="chatInput" placeholder="Ketik pesan..." class="flex-1 border p-2 rounded" />
            <button onclick="sendMessage()" class="bg-indigo-500 text-white px-4 rounded">Kirim</button>
        </div>
    </div>

    <!-- ðŸ”¥ Firebase & Logic -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-app.js";
      import { getDatabase, ref, push, set, onChildAdded, onChildRemoved, onValue, update, get, remove } 
        from "https://www.gstatic.com/firebasejs/9.24.0/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCIISpCe24KexjiiNYpuM3v7DhMOtewT_8",
        authDomain: "whos-the-spy-game.firebaseapp.com",
        databaseURL: "https://whos-the-spy-game-default-rtdb.firebaseio.com",
        projectId: "whos-the-spy-game",
        storageBucket: "whos-the-spy-game.firebasestorage.app",
        messagingSenderId: "267041654513",
        appId: "1:267041654513:web:f961b8ff449b0b1df20b50",
        measurementId: "G-1EZ9KQVTKC"
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      let local = { roomCode:null, playerId:null, playerName:null, isHost:false, players:{} };

      function generateRoomCode() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        return Array.from({length:6},()=>chars[Math.floor(Math.random()*chars.length)]).join('');
      }

      // === CREATE ROOM ===
      window.createRoom = async function() {
        const hostName = document.getElementById('hostName').value.trim();
        if (!hostName) return alert("Isi nama dulu!");
        const roomCode = generateRoomCode();
        const now = Date.now();

        await set(ref(db, `rooms/${roomCode}`), {
          createdAt: now,
          state: { gameStarted: false }
        });

        const playerId = `p_${now}`;
        await set(ref(db, `rooms/${roomCode}/players/${playerId}`), {
          name: hostName,
          isHost: true,
          alive: true
        });

        local = { roomCode, playerId, playerName: hostName, isHost:true, players:{} };

        document.getElementById('createRoom').classList.add('hidden');
        document.getElementById('waitingRoom').classList.remove('hidden');
        document.getElementById('displayRoomCode').textContent = roomCode;
        document.getElementById('startGameBtn').classList.remove('hidden');

        listenRoom(roomCode);
      };

      // === JOIN ROOM ===
      window.joinRoom = async function() {
        const name = document.getElementById('playerName').value.trim();
        const roomCode = document.getElementById('roomCode').value.trim().toUpperCase();
        if (!name || !roomCode) return alert("Isi nama + kode!");

        const snap = await get(ref(db, `rooms/${roomCode}`));
        if (!snap.exists()) return alert("Room tidak ada!");

        const playerId = `p_${Date.now()}`;
        await set(ref(db, `rooms/${roomCode}/players/${playerId}`), {
          name,
          isHost: false,
          alive: true
        });

        local = { roomCode, playerId, playerName: name, isHost:false, players:{} };

        document.getElementById('joinRoom').classList.add('hidden');
        document.getElementById('waitingRoom').classList.remove('hidden');
        document.getElementById('displayRoomCode').textContent = roomCode;

        listenRoom(roomCode);
      };

      // === START GAME ===
      window.startGame = async function() {
        if (!local.isHost) return alert("Hanya host!");
        await update(ref(db, `rooms/${local.roomCode}/state`), { gameStarted: true });
      };

      // === SEND CHAT ===
      window.sendMessage = async function() {
        const input = document.getElementById('chatInput');
        const text = input.value.trim(); if (!text) return;
        await set(push(ref(db, `rooms/${local.roomCode}/chat`)), {
          player: local.playerName,
          message: text,
          ts: Date.now()
        });
        input.value = '';
      };

      // === LISTEN ROOM ===
      function listenRoom(roomCode) {
        onChildAdded(ref(db, `rooms/${roomCode}/players`), snap => {
          local.players[snap.key] = snap.val();
          updatePlayerList();
        });
        onChildRemoved(ref(db, `rooms/${roomCode}/players`), snap => {
          delete local.players[snap.key];
          updatePlayerList();
        });

        onChildAdded(ref(db, `rooms/${roomCode}/chat`), snap => {
          const m = snap.val();
          addMessage(m.player, m.message);
        });

        onValue(ref(db, `rooms/${roomCode}/state`), snap => {
          const st = snap.val();
          if (st && st.gameStarted) {
            document.getElementById('waitingRoom').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
          }
        });
      }

      function updatePlayerList() {
        const list = document.getElementById('playerList');
        list.innerHTML = '';
        Object.values(local.players).forEach(p => {
          const div = document.createElement('div');
          div.className = "p-2 bg-gray-100 rounded";
          div.textContent = p.name + (p.isHost ? " ðŸ‘‘" : "");
          list.appendChild(div);
        });
        document.getElementById('currentPlayerCount').textContent = Object.keys(local.players).length;
      }

      function addMessage(player, msg) {
        const div = document.createElement('div');
        div.className = "p-2 bg-indigo-50 rounded";
        div.textContent = player + ": " + msg;
        document.getElementById('chatMessages').appendChild(div);
        document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
      }

      // keluar room kalau close tab
      window.addEventListener('beforeunload', async () => {
        if (local.roomCode && local.playerId) {
          await remove(ref(db, `rooms/${local.roomCode}/players/${local.playerId}`));
        }
      });
    </script>
</body>
</html>
